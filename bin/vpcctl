#!/bin/bash

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# State management
STATE_DIR="/etc/vpcctl"
STATE_FILE="$STATE_DIR/vpcs.json"

# Logging functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root (use sudo)"
        exit 1
    fi
}

# Initialize state file
init_state() {
    if [[ ! -d "$STATE_DIR" ]]; then
        mkdir -p "$STATE_DIR"
    fi
    if [[ ! -f "$STATE_FILE" ]]; then
        echo '{}' > "$STATE_FILE"
    fi
}

# Check if VPC exists
vpc_exists() {
    local vpc_name=$1
    init_state
    
    if command -v jq &> /dev/null; then
        jq -e --arg name "$vpc_name" '.[$name]' "$STATE_FILE" > /dev/null 2>&1
    else
        grep -q "\"$vpc_name\"" "$STATE_FILE" 2>/dev/null
    fi
}

# Save VPC state
save_vpc_state() {
    local vpc_name=$1
    local cidr=$2
    local bridge_name=$3
    
    init_state
    
    if command -v jq &> /dev/null; then
        local temp_file=$(mktemp)
        jq --arg name "$vpc_name" \
           --arg cidr "$cidr" \
           --arg bridge "$bridge_name" \
           '.[$name] = {
               "cidr": $cidr,
               "bridge": $bridge,
               "subnets": {},
               "created_at": (now | todate)
           }' "$STATE_FILE" > "$temp_file"
        mv "$temp_file" "$STATE_FILE"
    else
        # Fallback: simple append (not perfect but works)
        log_warning "jq not found, using basic state management"
        cat > "$STATE_FILE" <<EOF
{
  "$vpc_name": {
    "cidr": "$cidr",
    "bridge": "$bridge_name",
    "subnets": {},
    "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }
}
EOF
    fi
    
    log_info "Saved VPC state: $vpc_name"
}

# Create VPC
create_vpc() {
    local vpc_name=""
    local cidr=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --name)
                vpc_name="$2"
                shift 2
                ;;
            --cidr)
                cidr="$2"
                shift 2
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    # Validate
    if [[ -z "$vpc_name" || -z "$cidr" ]]; then
        log_error "Missing required arguments"
        echo "Usage: vpcctl create --name <name> --cidr <cidr>"
        exit 1
    fi
    
    # Check if VPC already exists
    if vpc_exists "$vpc_name"; then
        log_error "VPC '$vpc_name' already exists"
        exit 1
    fi
    
    log_info "Creating VPC: $vpc_name with CIDR: $cidr"
    
    # Generate bridge name
    local bridge_name="br-${vpc_name}"
    
    # Extract gateway IP (first IP + 1)
    local gateway_ip=$(echo "$cidr" | awk -F'[./]' '{print $1"."$2"."$3"."($4+1)"/"$5}')
    
    # Create Linux bridge
    log_info "Creating bridge: $bridge_name"
    ip link add "$bridge_name" type bridge 2>/dev/null || {
        log_error "Failed to create bridge. It may already exist."
        exit 1
    }
    
    # Bring bridge up
    ip link set "$bridge_name" up
    
    # Assign IP to bridge
    ip addr add "$gateway_ip" dev "$bridge_name"
    
    log_info "✓ Bridge created: $bridge_name"
    log_info "✓ Gateway IP: $gateway_ip"
    
    # Enable IP forwarding
    sysctl -w net.ipv4.ip_forward=1 > /dev/null
    log_info "✓ IP forwarding enabled"
    
    # Save state
    save_vpc_state "$vpc_name" "$cidr" "$bridge_name"
    
    log_info "✓ VPC '$vpc_name' created successfully!"
    echo ""
    echo "Next steps:"
    echo "  1. List VPCs: sudo vpcctl list"
    echo "  2. Add subnets: sudo vpcctl add-subnet --vpc $vpc_name --name public --cidr 10.0.1.0/24"
}

# List VPCs
list_vpcs() {
    init_state
    
    log_info "Listing all VPCs"
    echo ""
    
    if [[ ! -s "$STATE_FILE" ]] || [[ "$(cat "$STATE_FILE")" == "{}" ]]; then
        echo "No VPCs found."
        echo "Create one with: sudo vpcctl create --name my-vpc --cidr 10.0.0.0/16"
        return
    fi
    
    # Print header
    printf "%-15s %-20s %-20s\n" "VPC NAME" "CIDR" "BRIDGE"
    printf "%-15s %-20s %-20s\n" "--------" "----" "------"
    
    # Simple parsing without jq
    if command -v jq &> /dev/null; then
        jq -r 'to_entries[] | "\(.key)|\(.value.cidr)|\(.value.bridge)"' "$STATE_FILE" | \
        while IFS='|' read -r name cidr bridge; do
            printf "%-15s %-20s %-20s\n" "$name" "$cidr" "$bridge"
        done
    else
        cat "$STATE_FILE"
    fi
}

# Delete VPC
delete_vpc() {
    local vpc_name=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --name)
                vpc_name="$2"
                shift 2
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    if [[ -z "$vpc_name" ]]; then
        log_error "Missing required argument: --name"
        exit 1
    fi
    
    if ! vpc_exists "$vpc_name"; then
        log_error "VPC '$vpc_name' does not exist"
        exit 1
    fi
    
    log_info "Deleting VPC: $vpc_name"
    
    local bridge_name="br-${vpc_name}"
    
    # Delete bridge
    if ip link show "$bridge_name" &> /dev/null; then
        ip link delete "$bridge_name"
        log_info "✓ Deleted bridge: $bridge_name"
    fi
    
    # Remove from state
    init_state
    if command -v jq &> /dev/null; then
        local temp_file=$(mktemp)
        jq --arg name "$vpc_name" 'del(.[$name])' "$STATE_FILE" > "$temp_file"
        mv "$temp_file" "$STATE_FILE"
    fi
    
    log_info "✓ VPC '$vpc_name' deleted successfully"
}

# Usage
usage() {
    cat << EOF
VPC Control Tool - Manage Virtual Private Clouds on Linux

Usage: vpcctl <command> [options]

Commands:
    create      Create a new VPC
    delete      Delete a VPC
    list        List all VPCs
    help        Show this help message

Examples:
    sudo vpcctl create --name dev-vpc --cidr 10.0.0.0/16
    sudo vpcctl list
    sudo vpcctl delete --name dev-vpc

EOF
}

# Main
check_root

COMMAND=$1
shift || true

case "$COMMAND" in
    create)
        create_vpc "$@"
        ;;
    delete)
        delete_vpc "$@"
        ;;
    list)
        list_vpcs "$@"
        ;;
    help|--help|-h|"")
        usage
        exit 0
        ;;
    *)
        log_error "Unknown command: $COMMAND"
        usage
        exit 1
        ;;
esac
